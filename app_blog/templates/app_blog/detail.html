{# æ–‡ç« è¯¦æƒ… #}
{% extends 'app_blog/base_blog.html' %}
{% load static %}
{% load blog_tags %}


{% block title %}
{{ post.title }}
{% endblock title %}

{% block content %}
<h1> {{ post.title }} </h1>
<p class='date'>
    ä½œè€… : <a href="{% url 'app_blog:post_list_by_author' post.author %}"> {{ post.author }}</a><br>
    åˆ†ç»„ : <a href="{% url 'app_blog:category_detail' post.category.slug %}"> {{ post.category }}</a><br>
    å‘å¸ƒäº{{ post.publish | date:"Y-m-j" }} æµè§ˆ{{ post.views }}æ¬¡<br>
    {% with post.tags.all as tages %}
    {% if tages %}
    <span class='tags'>
        æ ‡ç­¾:
        {% for tag in tages %}
        <a href="{% url 'app_blog:post_list_by_tag' tag.slug %}">
            {{ tag.name }}</a>
        {% if not forloop.last %} , {% endif %}
        {% endfor %}
    </span><br>
    {% endif %}
    {% endwith %}
    {% with total_likes=post.users_like.count users_like=post.users_like.all %}
    <a href="#" data-id="{{ post.id }}" data-action="{% if request.user in users_like %}un{% endif %}like" class="like">
        <span id="count">ğŸ‘ {{ total_likes }}</span>
    </a>
    {% endwith %}
</p>

{% comment %} {{ post.body| linebreaks }} {% endcomment %}
{{ post.body|markdown}}

<p><a href="{% url 'app_blog:post_share' post.id %}"> åˆ†äº«æ–‡ç«  </a></p>

<h2>ç›¸ä¼¼æ–‡ç« </h2>
{% for post in similar_posts %}
<p><a href="{{ post.get_absolute_url }}"> {{ post.title }}</a></p>
{% empty %}
æ²¡æœ‰ç›¸ä¼¼æ–‡ç« æ¨è
{% endfor %}

<div>
    {# with æ ‡ç­¾å¯ä»¥å°†æŸä¸ªå€¼èµ‹äºˆåˆ°æ–°çš„å˜é‡ä¸­,å¯¹äºé¿å…æ•°æ®åº“è®¿é—®æˆ–è€…å¤šæ¬¡è®¿é—®å¼€é”€äº¤çš„çš„æ–¹æ³•ååˆ†æœ‰ç”¨ #}
    {% with comments.count as total_comments %}
    {% ifnotequal total_comments 0 %}
    <h2> æœ‰ {{ total_comments }} æ¡è¯„è®º </h2>
    {% endifnotequal %}
    {% endwith %}

    {% for comment in comments %}
    <div>
        <p class="info">
            {{ forloop.counter }}#: {{ comment.name }}
            <i>è¯„è®ºæ—¥æœŸ:{{ comment.created }}</i>
        </p>
        {{ comment.body|linebreaks }}
    </div>
    {% empty %}
    <p>è¿˜æ²¡æœ‰è¯„è®º,å¿«æ¥æŠ¢æ¿å‡³å§!</p>
    {% endfor %}
</div>

<button id="btn1">ç‚¹å‡»å‘é€ajax</button>
<p id="pp1"></p>

{% if message %}
<p>{{message}}</p>
{% else %}
<h2>æ·»åŠ è¯„è®º</h2>
<form action='.' method='post'>
    <table>
        {{comment_form.as_table}}
    </table>
    {% csrf_token %}
    <p><input type='submit' vaule='Add comment'></p>

</form>
{% endif %}

{% endblock content %}

{% block javascript %}

<script src="{% static 'js/jquery.cookie_1.4.1.min.js' %}"></script>
<script>

    // æŒ‰é’®ç‚¹å‡»å¼‚æ­¥è¯·æ±‚
    $('#btn1').on('click', function () {
        $.ajax({
            url: '{% url "app_blog:ajax_app_test" %}',
            data: {
                'keyword': `å‘é€: ${Math.random()}`
            },
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                $("#pp1").text("è¿”å›ç»“æœæ˜¯: " + data.count)
            }
        });
    });

    var csrftoken = $.cookie('csrftoken');
    function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $(document).ready(function () {
        $('a.like').click(function (e) {
            e.preventDefault();
            var id = $(this).data('id');
            var action = $(this).data('action');

            $.ajax({
                url: '{% url "app_blog:blog_like" %}',
                data: {
                    'id': id,
                    'action': action,
                },
                type: 'POST',
                dataType: 'json',
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                },
                success: function (data) {
                    if (data['status'] == 'ok') {
                        var previous_action = $('a.like').data('action');

                        // å˜æ¢åŠ¨ä½œ
                        $('a.like').data('action', previous_action == 'like' ? 'unlike' : 'like');
                        // å˜æ¢é“¾æ¥å¯¹åº”æ–‡æœ¬
                        // $('a.like').text(previous_action == 'like' ? 'Unlike' : 'Like');

                        // æ›´æ–°æ€»ç‚¹èµæ•°
                        // var previous_likes = parseInt($('span.count').text());
                        // $('span.count').text(previous_action == 'like' ? previous_likes + 1 : previous_likes - 1);
                        $('span#count').text('ğŸ‘ ' + data['count']);
                    }
                    else {
                        window.location.href = "{% url 'app_user:login' %}?next={{ post.get_absolute_url }}"
                    }
                },
            });
        });
    });

</script>
{% endblock %}