{# æ–‡ç« è¯¦æƒ… #}


{% extends 'app_blog/base_blog.html' %}
{% load static %}
{% load blog_tags %}

<!-- HTML Title -->
{% block title %}{{ article.title }}{% endblock title %}

{% block css_style %}
<link rel="stylesheet" href="{% static 'mdeditor/css/editormd.preview.css' %}"/>
{% endblock css_style %}

<!-- Start Home -->
{% block home %}
<!-- æ–‡ç« æ ‡é¢˜ -->
<h1 class="title post_title"> {{ article.title }}</h1>
<!-- Meta ä¿¡æ¯ -->
<div class="article-meta">
    <!-- å‘å¸ƒæ—¶é—´ -->
    <span class="item article-meta-time">
        <time class="time" data-toggle="tooltip" data-placement="bottom" title="å‘å¸ƒæ—¶é—´: {{ article.pub_time | date:'Y-m-j H:i' }}">
            <i class="glyphicon glyphicon-time"></i>
            {{ article.pub_time | date:"Y-m-j H:i" }}
        </time>
    </span>
    <!-- ä½œè€… -->
    <span class="item article-meta-source" data-toggle="tooltip" data-placement="bottom" title="ä½œè€…: {{ article.author }}">
        <i class="glyphicon glyphicon-user"></i>
        <a href="{% url 'app_blog:article_list_by_author' article.author %}">{{ article.author }}</a>
    </span>
    <!-- åˆ†ç±» -->
    <span class="item article-meta-category" data-toggle="tooltip" data-placement="bottom" title="åˆ†ç±»: {{ article.category }}">
        <i class="glyphicon glyphicon-list"></i>
        <a href="{% url 'app_blog:category_detail' article.category.slug %}" title="">{{ article.category }}</a>
    </span>
    <!-- æ ‡ç­¾ -->
    {% with article.tags.all as tags%}
    {% if tags %}
    <span class="item article-meta-views" data-toggle="tooltip" data-placement="bottom" title="æ ‡ç­¾">
        <i class="glyphicon glyphicon-tag"></i>
        {% for tag in tags %}
        <a href="{% url 'app_blog:article_list_by_tag' tag.slug %}">
            {{ tag.name }}
        </a>
        {% if not forloop.last %},{% endif %}
        {% endfor %}
    </span>
    {% endif %}
    {% endwith %}
    <!-- æµè§ˆé‡ -->
    <span class="item article-meta-views" data-toggle="tooltip" data-placement="bottom" title="{{ article.views }} äººçœ‹è¿‡">
        <i class="glyphicon glyphicon-eye-open"></i>
        {{ article.views }}
    </span>
    <!-- è¯„è®ºæ•° -->
    <span class="item article-meta-comment" data-toggle="tooltip" data-placement="bottom" title="{{ article.comments.count }} æ¡è¯„è®º">
        <i class="glyphicon glyphicon-comment"></i>
        {{ article.comments.count }}
    </span>
    <!-- ç‚¹èµæ•° -->
    <span class="item article-meta-views" data-toggle="tooltip" data-placement="bottom" title="{{ article.users_like.count }} ç‚¹èµ">
        <i class="glyphicon glyphicon-heart"></i> 
        {{ article.users_like.count }}
    </span>
    <!-- superuser -->
    {% if request.user == article.author or request.user.is_superuser %}

    <a class="comment" href="{% url 'app_admin:update_article' article.id article.slug %}">
        <i class="glyphicon glyphicon-pencil"></i>ä¿®æ”¹</a>
    <a class="comment" href="{{ article.get_admin_url }}">
        <i class="glyphicon glyphicon-pencil"></i>adminä¸­ç¼–è¾‘</a>
    {% endif %}




</div>
{% endblock home %}


{% block blog_content_main %}

<!-- é¢åŒ…å±‘å¯¼èˆª -->
{% load_breadcrumb article %}

<!-- æ–‡ç« ä¸»ä½“ -->
<article class="card">
    <div class="entry-content">
        {{ article.body|custom_markdown}}
    </div>
</article>

<!-- æ–‡ç« ç»“å°¾ -->
<div class="article-footer">
    <span class="inner">æœªç»å…è®¸ä¸å¾—è½¬è½½</span>
</div>

<!-- æ¨èåˆ—è¡¨ -->
<div class="card">
    <div class="relates">
        <div class="title"><h3>ç›¸å…³æ¨è</h3></div>
        {% similar_articles article %}
    </div>
</div>

<p><a href="{% url 'app_blog:article_share' article.id %}"> åˆ†äº«æ–‡ç«  </a></p>

<!-- è¯„è®º -->
<div class="card">
    <div class="title" id="comment">
        <h3>è¯„è®º <small>æŠ¢æ²™å‘</small></h3>
    </div>

    <!-- è¯„è®ºè¡¨å• -->
    {% if article.comment_status == "o" %}
    <div id='respond'>
        {% if request.user.is_authenticated %}
            {% include "app_comments/post_comment.html" with obj=article form=comment_form %}
        {% else %}
        <p>æ‚¨è¿˜æ²¡æœ‰ç™»å½•ï¼Œè¯·æ‚¨ç™»<a href="{% url 'app_user:login' %}?next={{ article.get_absolute_url }}">ç™»å½•</a>åå‘è¡¨è¯„è®ºã€‚</p>
        {% endif %}
    </div>
    {% else %}
    æ–‡ç« å…³é—­äº†è¯„è®º
    {% endif %}

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <div>
        {# with æ ‡ç­¾å¯ä»¥å°†æŸä¸ªå€¼èµ‹äºˆåˆ°æ–°çš„å˜é‡ä¸­,å¯¹äºé¿å…æ•°æ®åº“è®¿é—®æˆ–è€…å¤šæ¬¡è®¿é—®å¼€é”€äº¤çš„çš„æ–¹æ³•ååˆ†æœ‰ç”¨ #}
        {% with comments.count as total_comments %}
        <h2> {{ total_comments }} æ¡è¯„è®º </h2>
        {% if total_comments != 0 %}
        <div class="commentlist">
            {% query comments parent_comment=None as parent_comments %}
            {% for comment_item in parent_comments %}
                {% with 0 as depth %}
                    {% include "app_comments/comment_item_tree.html" with obj=article %}
                {% endwith %}
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
    </div>
</div>

<button id="btn1">ç‚¹å‡»å‘é€ajax</button>
<p id="pp1"></p>

{% endblock blog_content_main %}


{% block script %}
<script src="{% static 'js/jquery.cookie_1.4.1.min.js' %}"></script>
<script>

    // å›å¤è¯„è®º
    function do_reply(parentid, username) {
        $('#id_parent_comment').val(parentid);
        $('#cancel_comment').show();
        $("#commentform").appendTo($("#comment-content-" + parentid));
    }

    // å–æ¶ˆå›å¤
    function cancel_reply() {
        $('#id_parent_comment').val('');
        $('#comments').text('æ·»åŠ è¯„è®º');
        $('#cancel_comment').hide();
        $("#commentform").appendTo($("#respond"));
    }

    // åˆ é™¤è¯„è®º
    function delete_comment(comment_id, obj_id){
        $.ajax({
            url: '{% url "app_comments:ajax_delete_comment" %}',
            data: {
                'comment_id':comment_id,
                'obj_id':obj_id,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            type: 'post',
            dataType: 'json',
            success: function (data) {
                if (data['status']==200){
                    $(`#div-comment-${comment_id}`).remove();
                    console.log('åˆ é™¤æˆåŠŸ!')
                }
            }
        });
    }

    // æŒ‰é’®ç‚¹å‡»å¼‚æ­¥è¯·æ±‚
    $('#btn1').on('click', function () {
        $.ajax({
            url: '{% url "app_blog:ajax_app_test" %}',
            data: {
                'keyword': `å‘é€: ${Math.random()}`
            },
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                $("#pp1").text("è¿”å›ç»“æœæ˜¯: " + data.count)
            }
        });
    });

    // è·å–csrftoken
    var csrftoken = $.cookie('csrftoken');
    function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    // ç‚¹èµ
    $(document).ready(function () {
        $('a.like').click(function (e) {
            e.preventDefault();
            var id = $(this).data('id');
            var action = $(this).data('action');

            $.ajax({
                url: '{% url "app_blog:blog_like" %}',
                data: {
                    'id': id,
                    'action': action,
                },
                type: 'POST',
                dataType: 'json',
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                },
                success: function (data) {
                    if (data['status'] == 'ok') {
                        var previous_action = $('a.like').data('action');

                        // å˜æ¢åŠ¨ä½œ
                        $('a.like').data('action', previous_action == 'like' ? 'unlike' : 'like');
                        // å˜æ¢é“¾æ¥å¯¹åº”æ–‡æœ¬
                        // $('a.like').text(previous_action == 'like' ? 'Unlike' : 'Like');

                        // æ›´æ–°æ€»ç‚¹èµæ•°
                        // var previous_likes = parseInt($('span.count').text());
                        // $('span.count').text(previous_action == 'like' ? previous_likes + 1 : previous_likes - 1);
                        $('span#count').text('ğŸ‘ ' + data['count']);
                    }
                    else {
                        window.location.href = "{% url 'app_user:login' %}?next={{ article.get_absolute_url }}"
                    }
                },
            });
        });
    });

</script>
{% endblock script %}
