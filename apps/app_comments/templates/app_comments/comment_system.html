{% load blog_tags %}


{% comment %}
å‚æ•°:
object: æ¨¡å‹çš„ä¸€æ¡å®ä¾‹, æ¯”å¦‚æŸç¯‡æ–‡ç« , æŸå¼ ç›¸ç‰‡
comments: objectä¸‹é¢çš„æ‰€æœ‰è¯„è®º
{% endcomment %}


<!-- è¯„è®ºè¡¨å•  -->
{% if object.comment_status and OPEN_SITE_COMMENT %}
<div id="comment" class="blog-form">
    <div class="section-heading-4 heading-dark">
        <h3 class="item-heading">è¯„è®º {{article.visible_comments_count}}</h3>
    </div>
    <form class="contact-form-box" name="add_comment">
        <div class="row gutters-15">
            {% csrf_token %}
            <input type="hidden" name="object_slug" value="{{object.slug}}">
            {% if not request.user.is_authenticated %}
            {# å¦‚æœç™»å½•å°±ä¸æ˜¾ç¤º name å’Œ email Form #}
            <div class="col-md-6 form-group">
                <input type="text" placeholder="Nickname* 20ä¸ªå­—ç¬¦å†…" class="form-control" name="nickname" value="6646"
                    required>
            </div>
            <div class="col-md-6 form-group">
                <input type="email" placeholder="E-mail*" class="form-control" name="email" value="891953720@qq.com"
                    required>
            </div>
            {% else %}
            <input type="hidden" name="username" value="{{request.user}}">
            {% endif %}
            <div class="col-12 form-group" style="position: relative;">
                <textarea placeholder="æ¥è¯´ç‚¹ä»€ä¹ˆ..." class="textarea form-control" name="comment_body" rows="4" required></textarea>
                <div style="position:absolute;bottom: 10px; left: 29px;">
                    <span style="margin-right: 5px;">ğŸ˜†</span>
                    <span style="margin-right: 5px;">ğŸ˜Œ</span>
                    <span style="margin-right: 5px;">ğŸ¤ª</span>
                </div>
            </div>
            <div class="col-12 form-group RL_layer">
                <p class="error-info"></p>
                <a href="#" class="btn item-btn cancel-comment">å–æ¶ˆå›å¤</a>
                <button id="send_comment" class="item-btn">å‘é€</button>
            </div>
        </div>
    </form>
</div>
{% endif %}

<!-- æ–‡ç« è¯„è®º -->
<div class="blog-comment">
    {% query comments parent_comment=None as parent_comments %}
    {% for comment_item in parent_comments %}
    {% with 0 as depth %}
    {% include "app_comments/comment_tree.html" with object=object %}
    {% endwith %}
    {% endfor %}
</div>


<script>
    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", $("[name='csrfmiddlewaretoken']").val())
        }
    });

    var $form = $('form[name=add_comment]'),
        $err_info_ele = $form.find('.error-info');

    $form.on('submit', add_comment);  // æ·»åŠ è¯„è®º
    $('a.cancel-comment').on('click', form_cancel);  // å–æ¶ˆå›å¤æŸæ¡è¯„è®º
    $('a.reply').on('click', form_reply);  // å›å¤æŸæ¡è¯„è®º
    $("input[id^='do_action_']").on('change', do_action);  // ç½®é¡¶è¯„è®º/éšè—è¯„è®º  ajax Patch

    $('.blog-comment .item-btn.extend').on('click', toggleChildrenComments);  // æ˜¾ç¤ºæˆ–éšè—å­è¯„è®º

    // æ˜¾ç¤ºæˆ–éšè—å­è¯„è®º
    function toggleChildrenComments() {
        var $this = $(this);
        $.when($this.parent().nextAll('.child-comment').slideToggle()).done(function (data) {
            if ($(data[0]).is(":visible")) {
                $this.find('i').css('transform', 'rotate(180deg)');
                $this.find('span').text('æŠ˜å ');
            } else {
                $this.find('i').css('transform', 'rotate(0deg)');
                $this.find('span').text('å±•å¼€');
            }
        })
        return false;
    };

    // å–æ¶ˆå›å¤æŸæ¡è¯„è®º
    function form_cancel() {
        $form.data('replyto', '')
        $('#comment form').remove();
        // $form[0].reset();  // reset form è¡¨å•
        $form.hide(200, () => { $('#comment').append($form); }).slideDown(400);
        return false;
    };

    // å›å¤æŸæ¡è¯„è®º
    function form_reply(e) {
        var $this = $(this),
            $parent = $this.parent();
        $form.data('replyto', $parent[0].id)
        // $form[0].reset();  // reset form è¡¨å•
        $form.hide(200, () => { $parent.after($form); }).slideDown(400, () => {
            $form.find('textarea').focus();
        });
        return false;
    };

    // æ·»åŠ è¯„è®º ajax Post
    function add_comment(e) {
        var replyto = $form.data('replyto');
        $.ajax({
            url: "{% url 'app_comments:view' %}",
            data: $form.serialize() + `&replyto=${replyto ? replyto : ''}`,
            type: 'POST',
            dataType: 'json',
            // å‘é€æ•°æ®åˆ°æœåŠ¡å™¨æ—¶æ‰€ä½¿ç”¨çš„å†…å®¹ç±»å‹
            contentType: "application/x-www-form-urlencoded",
            success: function (data) {
                if (data['status'] == 200) {
                    toastr.success(data['msg'])
                    $err_info_ele.text('è¯„è®ºæˆåŠŸ');
                    form_cancel();
                } else {
                    toastr.error(data['msg']);
                    $err_info_ele.text(data['msg']);
                }
            },
            error: function (xhr, status, error) {  // è¯·æ±‚å¤±è´¥è¿è¡Œçš„å‡½æ•°
                toastr.error(status);
                $err_info_ele.text(status + ', è¯·ç¨åå†è¯•');
            }
        });
        return false;
    };

    // ç½®é¡¶è¯„è®º/éšè—è¯„è®º  ajax Patch
    function do_action(e) {
        let ele = e.currentTarget,
            init_status = ele.checked;
        let data = `${ele.name}=${init_status}&uid=${ele.id.split('-')[1]}`;
        $.ajax({
            url: "{% url 'app_comments:view' %}",
            data: data,
            type: 'PATCH',
            dataType: 'json',
            success: function (data) {
                if (data['status'] == 200) {
                    toastr.success(data['msg']);
                } else {
                    toastr.error(data['msg']);
                    // ele.checked = init_status?'':'on';
                    setTimeout(() => { ele.checked = init_status ? '' : 'on'; }, 100);
                }
            },
            error: function (xhr, status, error) {  // è¯·æ±‚å¤±è´¥è¿è¡Œçš„å‡½æ•°
                toastr.error(status);
                // ele.checked = init_status?'':'on';
                setTimeout(() => { ele.checked = init_status ? '' : 'on'; }, 100);
            },
        });
    };



</script>