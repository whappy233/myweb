
{% comment %}
å‚æ•°:
object: æ¨¡å‹çš„ä¸€æ¡å®ä¾‹, æ¯”å¦‚æŸç¯‡æ–‡ç« , æŸå¼ ç›¸ç‰‡
{% endcomment %}


<!-- è¯„è®ºè¡¨å•  -->
{% if object.comment_status and OPEN_SITE_COMMENT %}
<div id="comment" class="blog-form" data-isshow=false>
    <div class="section-heading-4 heading-dark">
        <h3 class="item-heading">è¯„è®º {{article.visible_comments_count}}</h3>
    </div>
    <form class="contact-form-box" name="add_comment" method="POST">
        <div class="row gutters-15">
            {% csrf_token %}
            <input type="hidden" name="object_slug" value="{{object.slug}}">
            {% if not request.user.is_authenticated %}
            {# å¦‚æœç™»å½•å°±ä¸æ˜¾ç¤º name å’Œ email Form #}
            <div class="col-md-6 form-group">
                <input type="text" placeholder="Nickname* 20ä¸ªå­—ç¬¦å†…" class="form-control" name="nickname" required>
            </div>
            <div class="col-md-6 form-group">
                <input type="email" placeholder="E-mail*" class="form-control" name="email" required>
            </div>
            {% else %}
            <input type="hidden" name="username" value="{{request.user}}">
            {% endif %}
            <div class="col-12 form-group" style="position: relative;">
                <textarea placeholder="æ¥è¯´ç‚¹ä»€ä¹ˆ..." class="textarea form-control" name="comment_body" rows="4"
                    required></textarea>
                <div style="position:absolute;bottom: 10px; right: 29px;">
                    <span style="margin-right: 5px;">ğŸ˜†</span>
                    <span style="margin-right: 5px;">ğŸ˜Œ</span>
                    <span style="margin-right: 5px;">ğŸ¤ª</span>
                </div>
            </div>
            <div class="col-12 form-group RL_layer">
                <p class="error-info"></p>
                <a href="#" class="btn item-btn cancel-comment">å–æ¶ˆå›å¤</a>
                <input type="button" id="send_comment" class="item-btn" value="å‘é€">
            </div>
        </div>
    </form>
</div>
{% endif %}

<!-- æ–‡ç« è¯„è®º -->
<div class="blog-comment"></div>

<div class="preloader mini-preloader">
    <div class="loader">
        <div class="line line1"></div>
        <div class="line line2"></div>
        <div class="line line3"></div>
    </div>
</div>


<script>
(function ($) {
    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", $("[name='csrfmiddlewaretoken']").val());
        }
    });

    var $form = $('form[name=add_comment]'),
        $submit_button = $('#send_comment'),
        $err_info_ele = $form.find('.error-info'),
        $comment_sys = $('#comment'),
        $win = $(window),
        $comment_container = $('.blog-comment'),
        AUTHOR_UUID = '{{object.author.profile.uuid}}',
        AUTHOR_SP = '{{request.user.is_superuser}}';

    $win.scroll(scroll_toshow_comments);  // æ»šåŠ¨åˆ°æŒ‡å®šä½ç½®åŠ è½½è¯„è®º
    $comment_sys.on('click', '#send_comment', add_comment);  // æ·»åŠ è¯„è®º
    $comment_container.on('click', '#send_comment', add_comment);  // æ·»åŠ è¯„è®º

    $comment_container.on('click', 'a.cancel-comment', form_cancel);  // å–æ¶ˆå›å¤æŸæ¡è¯„è®º
    $comment_container.on('click', 'a.reply', form_reply);  // å›å¤æŸæ¡è¯„è®º
    $comment_container.on('click', '.item-btn.extend', toggleChildrenComments);  // æ˜¾ç¤ºæˆ–éšè—å­è¯„è®º

    $comment_container.on('change', "input[id^='do_action_']", do_action);  // ç½®é¡¶è¯„è®º/éšè—è¯„è®º  ajax Patch

    $comment_container.on('mouseover', '.reply[data-reply]', HighlightComment).on('mouseleave', '.reply[data-reply]', HighlightComment);  // é«˜äº®å›å¤çš„è¯„è®º

    $('.markdown-body .codehilite>pre>span').on('click', copycode); // å¤åˆ¶ä»£ç 


    // æ˜¾ç¤ºæˆ–éšè—å­è¯„è®º
    function toggleChildrenComments() {
        var $this = $(this);
        $.when($this.parent().nextUntil('[class="media media-none--xs"]').filter('.child-comment').slideToggle()).done(function (data) {
            if ($(data[0]).is(":visible")) {
                $this.find('i').css('transform', 'rotate(180deg)');
                $this.find('span').text('æŠ˜å ');
            } else {
                $this.find('i').css('transform', 'rotate(0deg)');
                $this.find('span').text('å±•å¼€');
            }
        })
        return false;
    };

    // å–æ¶ˆå›å¤æŸæ¡è¯„è®º
    function form_cancel() {
        $form.data('replyto', '')
        $('#comment form').remove();
        // $form[0].reset();  // reset form è¡¨å•
        $form.hide(200, () => { $comment_sys.append($form); }).slideDown(400);
        return false;
    };

    // å›å¤æŸæ¡è¯„è®º
    function form_reply(e) {
        var $this = $(this),
            $parent = $this.parent();
        $form.data('replyto', $parent[0].id)
        // $form[0].reset();  // reset form è¡¨å•
        $form.hide(200, () => { $parent.after($form); }).slideDown(400, () => {
            $form.find('textarea').focus();
        });
        return false;
    };

    // æ·»åŠ è¯„è®º ajax Post
    function add_comment(e) {
        var replyto = $form.data('replyto'),
            $this = $(this);
        // e.preventDefault();   // é˜»æ­¢äº‹ä»¶çš„é»˜è®¤è¡Œä¸º
        // e.stopPropagation();  // é˜»æ­¢äº‹ä»¶å‘ä¸Šå†’æ³¡
        $.ajax({
            url: "{% url 'app_comments:view' %}",
            data: $form.serialize() + `&replyto=${replyto ? replyto : ''}`,
            type: 'POST',
            dataType: 'json',
            // å‘é€æ•°æ®åˆ°æœåŠ¡å™¨æ—¶æ‰€ä½¿ç”¨çš„å†…å®¹ç±»å‹
            contentType: "application/x-www-form-urlencoded",
            success: function (data) {
                if (data['status'] == 200) {
                    toastr.success(data['msg'])
                    $err_info_ele.text('è¯„è®ºæˆåŠŸ');
                    form_cancel();
                } else {
                    toastr.error(data['msg']);
                    $err_info_ele.text(data['msg']);
                }
            },
            error: function (xhr, status, error) {  // è¯·æ±‚å¤±è´¥è¿è¡Œçš„å‡½æ•°
                toastr.error(status);
                $err_info_ele.text(status + ', è¯·ç¨åå†è¯•');
            },
            beforeSend: function () {
                // è®¾ç½®æäº¤æŒ‰é’®å¤±æ•ˆï¼Œä»¥å®ç°é˜²æ­¢æŒ‰é’®é‡å¤ç‚¹å‡»
                $this.attr('disabled', true);
                $this.val('æäº¤ä¸­...');
            },
            complete: function () {
                $this.removeAttr('disabled');
                $this.val('å‘é€');
            },
        });
        return false;
    };

    // ç½®é¡¶è¯„è®º/éšè—è¯„è®º  ajax Patch
    function do_action(e) {
        let ele = e.currentTarget,
            init_status = ele.checked;
        let data = `${ele.name}=${init_status}&uid=${ele.id.split('-')[1]}`;
        $.ajax({
            url: "{% url 'app_comments:view' %}",
            data: data,
            type: 'PATCH',
            dataType: 'json',
            success: function (data) {
                if (data['status'] == 200) {
                    toastr.success(data['msg']);
                } else {
                    toastr.error(data['msg']);
                    // ele.checked = init_status?'':'on';
                    setTimeout(() => { ele.checked = init_status ? '' : 'on'; }, 100);
                }
            },
            error: function (xhr, status, error) {  // è¯·æ±‚å¤±è´¥è¿è¡Œçš„å‡½æ•°
                toastr.error(status);
                // ele.checked = init_status?'':'on';
                setTimeout(() => { ele.checked = init_status ? '' : 'on'; }, 100);
            },
        });
    };

    // é«˜äº®å›å¤çš„è¯„è®º
    function HighlightComment(e) {
        var $this = $(this),
            c = u = '';
        var comment_user = $this.data('reply');
        [c, u] = comment_user.split('-');
        var tar = $(`[id=${c}][data-author=${u}]`);
        if (tar) {
            if (e.type == 'mouseover') {
                tar.addClass('HighlightBox');
            } else {
                tar.removeClass('HighlightBox');
            };
        };
    };

    // $.getJSON åŠ è½½è¯„è®º
    function load_comments(kargs){
        function success(data, status, xhr) {
            console.log(data);
            var extend_child = '<div href="#" class="item-btn extend" title="å±•å¼€å­è¯„è®º"><i class="fas fa-chevron-circle-down"></i> <span>å±•å¼€</span></div>';
            data.forEach(d => {
                var cls = '',
                    margin_left = '0px';
                if (d.parent_comment) {
                    cls = ' child-comment';
                    margin_left = '40px';
                };

                // å®¹å™¨
                var one_comment_container = $(`<div id="${d.uuid}" class="media media-none--xs${cls}" style="display: none;" data-author="${d.author.uuid}"></div>`);

                // å¤´åƒ
                var avatar_container = $(`<figure style="margin-left: ${margin_left}" class="avatar avatar-lg"></figure>`);
                if (d.author.photo) {
                    var avatar = $(`<img src="${d.author.photo}" class="rounded-circle" alt="avatar" />`);
                } else {
                    // var avatar = $(`<span class="avatar-title bg-primary rounded-circle">${d.author.username[0]}</span>`);
                    var avatar = $(`<img options="size=25x25&color=#fff&text=${d.author.username[0]}&fstyle=oblique&fsize=20&ffamily=consolas" class="placeholder rounded-circle" alt="avatar" />`);
                };

                avatar_container.append(avatar);
                one_comment_container.append(avatar_container);

                var comment_body = $(`<div class="media-body" id="content-${d.uuid}"></div>`);
                var nickname = $('<div class="item-title"></div>');
                var content = $(`<div class="item-body"><p>${d.body}</p></div>`);
                var z = `<span class="item-nickname">${d.author.username}</span>`;
                var x = AUTHOR_UUID == d.author.uuid ? '<span class="item-meta badge badge-success">ä½œè€…</span>' : '';
                var y = '';

                // å›å¤çš„ç”¨æˆ·
                if (d.parent_comment) {
                    var b = `<div class="reply" data-reply="${d.parent_comment.uuid}-${d.parent_comment.author_uuid}"><span class="item-nickname">å›å¤: ${d.parent_comment.username}</span>`;
                    var h = AUTHOR_UUID == d.parent_comment.author_uuid ? '<span class="badge badge-success">ä½œè€…</span>' : '';
                    y = b + h + '</div>';
                };

                // é¡¶ç½®è¯„è®º
                var k = d.is_overhead ? '<span class="item-meta badge badge-warning">é¡¶ç½®</span>' : '';
                // è¯„è®ºæ—¥æœŸ
                var t = `<span class="item-subtitle">${d.created_time}</span>`

                nickname.append(z + x + y + k + t);
                comment_body.append(nickname);
                comment_body.append(content);
                one_comment_container.append(comment_body);

                // è¶…çº§ç”¨æˆ·æ§åˆ¶
                if (AUTHOR_SP == 'True') {
                    var hide_switch = `<div class="item-btn visible"><div class="custom-control custom-switch custom-control-inline">
                                            <input name='is_hide' type="checkbox" class="custom-control-input" id="do_action_hide-${d.uuid}" ${d.is_hide ? 'checked' : ''}>
                                            <label class="custom-control-label" for="do_action_hide-${d.uuid}">éšè—</label></div></div>`;
                    one_comment_container.append(hide_switch);
                    if (!d.parent_comment) {
                        var to_overhead = `<div class="item-btn overhead"><div class="custom-control custom-switch custom-control-inline">
                                                <input name='is_overhead' type="checkbox" class="custom-control-input" id="do_action_overhead-${d.uuid}" ${d.is_overhead ? 'checked' : ''}>
                                                <label class="custom-control-label" for="do_action_overhead-${d.uuid}">ç½®é¡¶</label></div></div>`;
                        one_comment_container.append(to_overhead);
                    }
                };

                // å›å¤æŒ‰é’®
                one_comment_container.append('<a href="#" class="item-btn reply"><i class="far fa-comment-dots"></i></a>');

                // æŠ˜å å­è¯„è®º
                if (d.parent_comment) {
                    var $sible_prev = $comment_container.children().last();
                    if ($sible_prev.not('.child-comment').length > 0) {
                        $sible_prev.append(extend_child);
                    };
                };

                $comment_container.append(one_comment_container);
                if (!d.parent_comment) {
                    one_comment_container.slideDown(500);
                }
            });
        };

        $.getJSON('/comment', { a: 123, b: 456 }, success);
    };

    // æ»šåŠ¨åˆ°æŒ‡å®šä½ç½®åŠ è½½è¯„è®º
    function scroll_toshow_comments() {
        if (!$comment_sys.data().isshow) {
            var itemOffsetTop = $comment_sys.offset().top,     // å…ƒç´ è·ç¦»é¡µé¢é¡¶éƒ¨çš„è·ç¦»
                itemOuterHeight = $comment_sys.outerHeight(),  //è¿™ä¸ªæ–¹æ³•å¯ä»¥ä¼ é€’ä¸€ä¸ªå‚æ•°true, å¦‚æœä¼ é€’è¡¨ç¤ºéœ€è¦æ±‚å‡ºçš„é«˜åº¦å«æœ‰å¤–è¾¹è·, å¦åˆ™ä¸å«æœ‰. å…·ä½“è§†éœ€æ±‚è€Œå®š.
                winHeight = $win.height(),  // æµè§ˆå™¨å¯è§åŒºåŸŸçš„é«˜åº¦
                winScrollTop = $win.scrollTop();  // é¡µé¢æ»šåŠ¨çš„è·ç¦»
            if (!(winScrollTop > itemOffsetTop + itemOuterHeight) && !(winScrollTop < itemOffsetTop - winHeight)) {
                $comment_sys.data().isshow = true;
                load_comments();
            }
        }
    }

    function copycode(event) {
        var $this = $(event.currentTarget);
        var $code = $this.next('code');
        if ($code) {
            let transfer = document.createElement('textarea');
            let original_code = $code.text();
            let copytext = `${original_code}\n${new Array(40).join('-')}\n{{SITE_NAME}}|${document.title}\n${document.location.href} (è½¬è½½è¯·å¤‡æ³¨æ¥æºğŸ˜š)\n${new Date()}`;
            document.body.appendChild(transfer);
            transfer.value = copytext;  // è¿™é‡Œè¡¨ç¤ºæƒ³è¦å¤åˆ¶çš„å†…å®¹
            transfer.select();
            if (document.execCommand('copy')) {
                document.execCommand('copy');
            }
            toastr.success('å¤åˆ¶æˆåŠŸ');
            document.body.removeChild(transfer);
        };
        return false;
    };


})(jQuery)
</script>